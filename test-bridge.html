<!DOCTYPE html>
<html>
  <head>
    <title>Empythoned</title>
    <!-- <script src="python-prebuilt.opt.js"></script> -->
    <!--<script src="perf-tests.js"></script>-->
    <script src="http://localhost:8000/bifrost-bridge.js"> </script>
    <script src="raphael.js"> </script>
    <script>
      function start() {
        var input = document.getElementById('input');
        var output = document.getElementById('output');
        var button = document.getElementById('button');

        var handleChr = function(chr) {
            if (chr !== null)
                output.value += String.fromCharCode(chr);
        };

        Python.initialize(null, handleChr, function() {
            button.onclick = function() {
                Python.isFinished(input.value, function(isFinished) {
                    if (isFinished) {
                        output.value = '';
                        Python.eval(input.value, function(result) {
                            if (result !== null && result !== undefined) {
                              output.value += '\n--------------------------\nResult: ' + result;
                            }
                            output.scrollTop = output.scrollHeight;
                        });
                    } else {
                        output.value = 'Command not finished.';
                    }
                });
            };
        });

        //registerPerfTests();
      };
     //window.onBifrostReady = start;
     window.onload = start;
    </script>
  </head>
  <body>
    <!--<div id='give_me_empythoned_please'></div>-->
    <h1>Empythoned Demo</h1>
    <textarea id="input" style="font-family: monospace; width: 80%" rows="8">import bifrost

class JSWrapper:
    def __init__(self, pyjs, jsID, parentJSID):
        self.createLocal__("pyjs__")
        self.createLocal__("jsID__")
        self.createLocal__("parentJSID__")
        self.pyjs__ = pyjs
        self.jsID__ = jsID
        self.parentJSID__ = parentJSID

    def createLocal__(self, attr):
        self.__dict__[attr] = None

    def __setattr__(self, attr, value):
        if attr in self.__dict__:
            self.__dict__[attr] = value
        else :
            self.pyjs__.setJSBlobPrimitive(self.jsID__, attr, value)

    def __getattr__(self, attr):
        newID = self.pyjs__.getJSBlobProperty(self.jsID__, attr)
        return self.getWrappedBlob__(newID)

    def __call__(self, *args):
        newID = self.pyjs__.callJSBlob(self.parentJSID__, self.jsID__, args)
        return self.getWrappedBlob__(newID)

    def getWrappedBlob__(self, id):
        isPrimitive = self.pyjs__.blobs[id][1]
        if isPrimitive:
            primitive = self.pyjs__.getJSBlobPrimitive(id)
            #TODO: delete the reference
            return primitive
        else :
           return JSWrapper(self.pyjs__, id, self.jsID__)


class Bifrost:
  def __init__(self):
    self.windowId = 0
    self.nextId = 1
    self.blobs = {0: (self.windowId, False)}
    self.primitive = None
    self.error = None

  def jserror(self):
    err = self.error
    self.nextId -= 1 #throw out that blob index
    self.error = None #reset error
    raise Exception(err)

  def call(self, jsstring):
    bifrost.run(jsstring)

    #rewrite, messy hack at 5am
  def callJSBlob(self, parentjsid, jsid, args):
    jsID = self.blobs[jsid][0]
    jsArgs = []
    for arg in args:
        jsArgs.append(self.convertToJSObject(arg))
    currentId = self.nextId
    self.call("window.bifrost.callBlobFunction(" + str(parentjsid) +", " + str(jsid) + ", " + str(currentId) + ", " + str(jsArgs) + ")") 
    self.nextId += 1
    if (self.error is not None):
        self.jserror()
    return currentId

  def getJSBlobProperty(self, jsID, property): 
    currentId = self.nextId
    self.call("window.bifrost.createBlobFromBlobProperty(" + str(jsID) + ", \"" + str(property) + "\", " + str(currentId) + ")") 
    self.nextId += 1
    if (self.error is not None):
        self.jserror()
    return currentId

  def getJSBlobPrimitive(self, pythonID):
    jsID = self.blobs[pythonID][0]
    self.call("window.bifrost.getBlobPrimitive(" + str(jsID) + ")")
    if (self.error is not None):
        self.jserror()
    return self.primitive

  def setJSBlobPrimitive(self, pythonID, property, value):
    jsID = self.blobs[pythonID][0]
    self.call("window.bifrost.setBlobPropertyToPrimitive(" + str(jsID) + ", \"" + str(property) + "\", " + self.convertToJSObject(value) + ")")
    if (self.error is not None):
        self.jserror()
    

    #rewrite, should be recursive 
  def convertToJSObject(self, pythonObj):
    if (type(pythonObj) == 'str'):
        return "\"" + pythonObj + "\""
    return str(pythonObj)

pyjs = Bifrost()
window = JSWrapper(pyjs, pyjs.windowId, pyjs.windowId)

</textarea>

    <input id="button" type="button" value="Execute" style="display: block; margin: auto" />
    <div id="counter">0</div>
    <canvas id="canvas" width="300" height="300"></canvas>  
    <textarea id="output" style="font-family: monospace; width: 80%" rows="8"></textarea>
    <hr>
  </body>
</html>
